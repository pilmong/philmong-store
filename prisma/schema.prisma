generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------------------------------------------------------
// 1. PROJECT PURCHASE (Legacy & Shared)
// ---------------------------------------------------------

enum PaymentMethod {
  TRANSFER    // 계좌이체
  CASH        // 현금
  CREDIT_CARD // 신용카드
  CHECK_CARD  // 체크카드
}

enum PaymentStatus {
  UNPAID    // 미결제
  PAID      // 결제완료
  REFUNDED  // 환불
  
  // Purchase specific
  ORDERED   // 발주완료
  RECEIVED  // 입고완료
  COMPLETED // 구매확정
  CANCELLED // 취소
  PENDING   // Legacy
}

enum UsageType {
  BUSINESS // 업무용
  PERSONAL // 개인용
}

model Purchase {
  id            String        @id @default(uuid())
  vendorName    String        // 거래처명
  date          DateTime      // 날짜
  paymentMethod PaymentMethod // 결제수단
  status        PaymentStatus // 결제구분
  
  items         PurchaseItem[]
  
  totalAmount   Int           @default(0) // 총계
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model PurchaseItem {
  id          String    @id @default(uuid())
  purchaseId  String
  purchase    Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  
  name        String    // 품목명
  quantity    Int       // 수량
  unitPrice   Int       // 단가
  amount      Int       // 소계
  usage       UsageType // 용도구분
  note        String?   // 비고
  isChecked   Boolean   @default(false)
  discountValue Int       @default(0)
  discountType  String    @default("UNIT")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Vendor {
  id        String   @id @default(uuid())
  name      String   @unique
  contact   String?
  website   String?
  note      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  name      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------------------------------------------------
// 2. PHILMONG STORE (New Features & Merged Product)
// ---------------------------------------------------------

// --- Master Data (Merged) ---

enum WorkDivision {
  IMMEDIATE_SUB_PORTIONING // 즉시 소분
  COOKING                 // 조리 상품
  PROCESSING               // 가공 상품
}

enum ProductStatus {
  SELLING        // 판매 중
  NOT_SELLING    // 미 판매
  PENDING        // 보류 중
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?  // 기본 설명 (레시피 팁 등)
  basePrice   Int      @default(0) // (Legacy: price) 기본 판매가
  
  type        ProductType @default(REGULAR)
  category    ProductCategory? 

  // Legacy Fields (restored)
  workDivision    WorkDivision  @default(IMMEDIATE_SUB_PORTIONING)
  status          ProductStatus @default(SELLING)
  standardQuantity Int?          // 진열상품 기준 수량
  sellingDate     DateTime?     // 판매 날짜 (Legacy Daily logic)
  plannedQuantity Int?          // 생산 수량
  
  // Relations
  plans           MenuPlan[]
  prices          ClientProductPrice[]
  lunchBoxConfig  LunchBoxConfig?
  orderRequests   OrderRequestItem[] // (Legacy)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([type])
  @@index([sellingDate])
}

enum ProductType {
  REGULAR   // 정규 메뉴 (상시/매일)
  DAILY     // 데일리 메뉴 (기획 필요)
  SPECIAL   // 특별 메뉴 (기간 예약)
  LUNCH_BOX // B2B 도시락
  SALAD     // B2B 샐러드
}

enum ProductCategory {
  TODAY_MENU // 오늘의 메뉴
  MAIN_DISH  // 요리 곁들임
  SOUP       // 국물 곁들임
  SIDE_DISH  // 반찬 곁들임
  KIMCHI     // 김치 곁들임
  PICKLE     // 장아찌 곁들임
  SAUCE      // 청/소스 곁들임

  // B2B 전용 카테고리 (독립 운영)
  LUNCH_RICE // 도시락 밥
  LUNCH_SOUP // 도시락 국
  LUNCH_MAIN // 도시락 메인
  LUNCH_SIDE // 도시락 반찬
  SALAD_MAIN // 샐러드 메인
}

enum B2BPaymentMethod {
  CARD
  CASH
}

enum B2BPaymentTiming {
  IMMEDIATE // 매일 납품 즉시 결제
  DEFERRED  // 지정 날짜 합산 결제
}

// --- Legacy B2B Logic (Restored) ---

model Client {
  id              String        @id @default(cuid())
  name            String
  code            String?       @unique // (New: Login Code)
  manager         String?       // (Legacy: managerEmail? No, merging)
  managerEmail    String?       // (Legacy)
  contact         String?
  address         String?       // (New)
  
  category        String?       // (Legacy)
  isVatInclusive  Boolean       @default(true) // (Legacy)
  note            String?

  // B2B Payment & Price Info
  paymentMethod   B2BPaymentMethod @default(CARD)
  paymentTiming   B2BPaymentTiming @default(IMMEDIATE)
  lunchUnitPrice  Int           @default(7000) // Default price, adjustable per client
  saladUnitPrice  Int           @default(7000)


  // Relations
  customPrices    ClientProductPrice[]
  orderRequests   OrderRequest[] // (Legacy Orders)
  orders          ClientOrder[]  // (New Orders)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model ClientProductPrice {
  id              String    @id @default(cuid())
  clientId        String
  productId       String
  customPrice     Int
  
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([clientId, productId])
}

model LunchBoxConfig {
  id              String    @id @default(cuid())
  productId       String    @unique
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  layoutType      String    @default("LUNCH_BOX")
  
  slotA           String?   
  slotB           String?
  slotC           String?
  slotD           String?
  slotE           String?
  slotF           String?
  slotG           String?
  slotH           String?
  slotI           String?
  slotJ           String?
  slotK           String?
  slotL           String?
  slotM           String?
  slotN           String?
  slotO           String?
  slotP           String?
  slotQ           String?
  slotR           String?
  slotS           String?
  slotT           String?
  slotU           String?
  slotV           String?
  slotW           String?
  slotX           String?
  slotY           String?
  slotZ           String?
  slotAA          String?
}

model OrderRequest {
  id              String    @id @default(cuid())
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id])
  targetDate      DateTime  
  
  items           OrderRequestItem[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model OrderRequestItem {
  id              String    @id @default(cuid())
  orderId         String
  productId       String?   
  itemName        String?   
  itemCategory    String?   
  quantity        Int
  
  order           OrderRequest @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product?     @relation(fields: [productId], references: [id])
}

// --- New B2B Logic (Simple Quantity) ---
model ClientOrder {
  id        String   @id @default(uuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id])
  
  date      DateTime 
  
  lunchBoxQuantity Int @default(0)
  saladQuantity    Int @default(0)
  
  note      String?
  status    OrderStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([clientId, date])
}

// --- Delivery & Coupons ---

model DeliveryZone {
  id          String   @id @default(uuid())
  name        String   // ex: "A zone", "B zone"
  price       Int      // ex: 4400, 5200
  
  areas       String[] 
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Coupon {
  id          String   @id @default(uuid())
  name        String   // ex: "예약상시쿠폰35"
  code        String?  @unique
  
  discountAmount Int   
  minOrderAmount Int   
  
  validFrom   DateTime?
  validUntil  DateTime?
  
  isActive    Boolean  @default(true)
  isAuto      Boolean  @default(false) // 자동 적용 여부 (금액 조건 충족 시)
  
  usedOrders  Order[]
  
  userCoupons UserCoupon[] // Relation to UserCoupon

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- Planning ---

model MenuPlan {
  id          String   @id @default(uuid())
  
  planDate    DateTime 
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  price       Int      
  quantityLimit Int?   
  soldQuantity  Int    @default(0)
  
  descriptionOverride String? 
  status      PlanStatus @default(PLANNED)

  orderItems  OrderItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([planDate])
}

enum PlanStatus {
  PLANNED   
  OPEN      
  CLOSED    
  SOLD_OUT  
}

// --- Sales & Orders (Customer App) ---

model Order {
  id            String   @id @default(uuid())
  orderNumber   String   @unique 
  
  customerName  String
  customerPhone String
  password      String?  

  totalAmount   Int
  pickupDate    String   
  pickupTime    String?  
  deliveryType  DeliveryType
  
  address       String?
  detailAddress String?
  deliveryZoneId String?
  deliveryFee   Int      @default(0)
  
  requestNote   String?

  couponId      String?
  coupon        Coupon?  @relation(fields: [couponId], references: [id])
  discountAmount Int     @default(0)

  status        OrderStatus @default(PENDING)
  paymentStatus PaymentStatus @default(UNPAID)
  
  items         OrderItem[]

  createdAt     DateTime @default(now())
  paymentDeadline DateTime? // 입금 기한
  paymentNotified Boolean  @default(false) // 입금 알림 여부 (고객 -> 관리자)
  
  updatedAt     DateTime @updatedAt
  
  userId        String?  // 회원 주문인 경우 연결
  user          User?    @relation(fields: [userId], references: [id])
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  menuPlanId  String
  menuPlan    MenuPlan @relation(fields: [menuPlanId], references: [id])
  
  productName String
  price       Int
  quantity    Int
  amount      Int      
}

enum DeliveryType {
  PICKUP
  DELIVERY
}

enum OrderStatus {
  PENDING   
  CONFIRMED 
  PREPARING 
  READY     
  COMPLETED 
  CANCELLED 
}

// --- Membership ---

model User {
  id        String   @id @default(uuid())
  name      String
  phone     String   @unique // Login ID
  password  String   // Hashed
  
  adminNote String?  // 관리자 메모 (특이사항 등)

  coupons   UserCoupon[]
  orders    Order[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserCoupon {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  couponId  String
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  
  isUsed    Boolean  @default(false)
  usedAt    DateTime?
  
  createdAt DateTime @default(now())
  
  @@unique([userId, couponId]) // Prevent duplicates if needed, or allow multiple same coupons? Let's unique for now for welcome coupon etc.
}


